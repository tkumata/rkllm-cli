# RKLLM Agent CLI 新設計ドキュメント

## 目的とスコープ

- RK3588 NPU 上で動く Codex 風エージェント CLI を構築する。
- Rust 製 CLI (`rkllm-cli`) を中核とし、ローカルファイル操作と MCP ツールの両方を扱えるようにする。
- 旧資料（`docs/RKLLM_RUST_CLI_REQUIREMENTS*.md`）は参照しない。本書が最新の前提と設計とする。

## モデルと推奨設定

- 推奨モデル: Qwen3 1.7B (RKLLM). `RKLLM_TEMPLATE=qwen` 環境変数で Qwen 用テンプレに切替（デフォルトは Qwen テンプレ）。
- 推奨パラメータ（RK3588 用の目安）: `max_new_tokens=1024~2048`, `top_k=40~64`, `top_p=0.9~0.95`, `temperature=0.7~0.9`, `repeat_penalty=1.05~1.1`.
- パフォーマンスを優先する場合は量子化モデル（int4/int8）を利用し、`max_new_tokens` を抑える。

## プロンプト設計（役割分離）

- system: 簡潔に「日本語で回答」「<files> は参照専用」「指示がない限り既存ファイルを上書きしない」等の方針のみを書く。
- user: ユーザー入力そのもの。
- context: `<files> ... </files>` に読み込んだファイルを入れる。ここは参照専用であり、LLM 出力では再掲禁止。
- tools: MCP クライアント接続成功時は短縮版ツール一覧を常時挿入し、各ツールに必須引数優先の `[TOOL_CALL]` JSON サンプルを付与。非接続時のみ省略。
- 出力フォーマット: 基本は `<file path="...">...content...</file>` を正とする。ブラケット形式 `[CREATE_FILE: path] ... [END_FILE]` は後方互換として許容する。
- 明示ルール:
  - `<files>` の内容はエコーしない。
  - 出力には「新規/更新が必要なファイル」だけを含める。
  - 既存ファイルの上書きは、ユーザーが明示した場合のみ。

## モード方針（CLI サブコマンド）

- `chat`: 通常のチャット＋ローカルファイル操作（安全ポリシー付き）。入力ファイル上書きは明示許可がない限り拒否。
- `tool-only`: MCP ツール専用モード。ローカルファイルの書き込みはしない（ファイル出力マーカーも無視）。

## ローカルファイル vs MCP ツールの優先順位

- デフォルト: ローカルファイル操作を優先（chat モード）。MCP クライアント接続時は短縮版ツール一覧＋サンプルを system プロンプトへ常に含め、ツール呼び出しは LLM 判断。
- tool-only モード: MCP ツールのみ実行し、ローカル書き込みは行わない。
- ローカル書き込みは「保存/作成」など明示的意図があるときだけ実行する。
- MCP ツール呼び出しは tool-only でなくても LLM が選択可能。
- ツール一覧の粒度は短縮版固定（全文/非表示のトグルなし）。`<tools>` の確認は `--preview-prompt` 等で行う。

## 安全ポリシー

- `<files>` で与えた入力ファイルは、明示的な上書き許可がない限り書き込み禁止。
- システムディレクトリ（/etc 等）への書き込みは常に拒否。
- 書き込み前にプレビュー（予定ファイル一覧 + ダイジェスト）を提示できるオプションを設ける（`--confirm-writes` など）。
- バックアップ/force オプションを CLI で用意し、ユーザーが選択できるようにする。

## 実行フロー（高レベル）

1. ユーザー入力を取得し、ファイルパスを検出。
2. 必要なファイルだけ読み込み `<files>` に格納（出力先ファイルは読み込まない）。
3. モードと安全ポリシーに基づき system プロンプトを組み立てる。
4. MCP に接続できた場合はツール短縮リストと `[TOOL_CALL]` サンプルを `<tools>` に付与。
5. LLM へ送信し、出力をファイルマーカーとツール呼び出しで解析。
6. ローカルファイル操作を優先して実行。入力ファイル上書きはモードと明示許可を確認。
7. MCP ツール呼び出しは opt-in で実行。結果をユーザーに返す。

## デバッグと運用

- 環境変数:
  - `RKLLM_TEMPLATE=qwen|gemma` でチャットテンプレ切替。
  - `RKLLM_DEBUG_PROMPT=1` で送信プロンプトを stderr に出力（開発時のみ）。
  - `<tools>` の内容を確認したい場合は `--preview-prompt` を併用し、`RKLLM_DEBUG_PROMPT=1` で送信内容を確認する。
  - 追加モデルを使う場合は `RKLLM_TEMPLATE=<name>` を設定し、テンプレ文字列を `src/llm.rs` に追加する（詳細は `docs/model_templates.md` 参照）。

## 今後のタスク（例）

- ファイル出力フォーマットを `<file path="...">` に統一し、ブラケット形式は互換扱いとして整理。
- プロンプトプレビューの表示を整形し、長さのみ表示/サマリ表示のトグルを整理。
- tool-only モード中心の運用ガイドを追記（MCP ツールのみ利用時のベストプラクティス）。
- 複数行入力時のカーソル移動/挿入操作の UX 改善。
