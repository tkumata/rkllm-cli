# RKLLM Agent CLI 新設計ドキュメント

## 目的とスコープ
- RK3588 NPU 上で動く Codex 風エージェント CLI を構築する。
- Rust 製 CLI (`rkllm-cli`) を中核とし、ローカルファイル操作と MCP ツールの両方を扱えるようにする。
- 旧資料（`docs/RKLLM_RUST_CLI_REQUIREMENTS*.md`）は参照しない。本書が最新の前提と設計とする。

## モデルと推奨設定
- 推奨モデル: Qwen3 1.7B (RKLLM). `RKLLM_TEMPLATE=qwen` 環境変数で Qwen 用テンプレに切替（デフォルトは Qwen テンプレ）。
- 推奨パラメータ（RK3588用の目安）: `max_new_tokens=1024~2048`, `top_k=40~64`, `top_p=0.9~0.95`, `temperature=0.7~0.9`, `repeat_penalty=1.05~1.1`.
- パフォーマンスを優先する場合は量子化モデル（int4/int8）を利用し、`max_new_tokens` を抑える。

## プロンプト設計（役割分離）
- system: 簡潔に「日本語で回答」「<files> は参照専用」「指示がない限り既存ファイルを上書きしない」等の方針のみを書く。
- user: ユーザー入力そのもの。
- context: `<files> ... </files>` に読み込んだファイルを入れる。ここは参照専用であり、LLM 出力では再掲禁止。
- tools: MCP ツール一覧は必要時のみ挿入。環境変数で挙動を切替（例: `RKLLM_SHOW_TOOL_LIST=1` で短縮版、`RKLLM_SHOW_TOOL_LIST_FULL=1` で全文）。
- 出力フォーマット: 基本は `<file path="...">...content...</file>` を正とする。ブラケット形式 `[CREATE_FILE: path] ... [END_FILE]` は後方互換として許容する。
- 明示ルール:
  - `<files>` の内容はエコーしない。
  - 出力には「新規/更新が必要なファイル」だけを含める。
  - 既存ファイルの上書きは、ユーザーが明示した場合のみ。

## モード方針（CLIサブコマンド）
- `chat`: 通常のチャット＋ローカルファイル操作（安全ポリシー付き）。入力ファイル上書きは明示許可がない限り拒否。
- `tool-only`: MCPツール専用モード。ローカルファイルの書き込みはしない（ファイル出力マーカーも無視）。

## ローカルファイル vs MCP ツールの優先順位
- デフォルト: ローカルファイル操作を優先（chat モード）。MCP ツールは opt-in（ツール一覧はデフォルト非表示）。
- tool-only モード: MCP ツールのみ実行し、ローカル書き込みは行わない。
- ツール一覧は短縮版/非表示をデフォルトとし、必要時にだけ表示する（環境変数等で切替）。

## 安全ポリシー
- `<files>` で与えた入力ファイルは、明示的な上書き許可がない限り書き込み禁止。
- システムディレクトリ（/etc 等）への書き込みは常に拒否。
- 書き込み前にプレビュー（予定ファイル一覧 + ダイジェスト）を提示できるオプションを設ける（`--confirm-writes` など）。
- バックアップ/force オプションを CLI で用意し、ユーザーが選択できるようにする。

## 実行フロー（高レベル）
1. ユーザー入力を取得し、ファイルパスを検出。
2. 必要なファイルだけ読み込み `<files>` に格納（出力先ファイルは読み込まない）。
3. モードと安全ポリシーに基づき system プロンプトを組み立てる。
4. （必要に応じて）MCP ツール短縮リストを付与。
5. LLM へ送信し、出力をファイルマーカーとツール呼び出しで解析。
6. ローカルファイル操作を優先して実行。入力ファイル上書きはモードと明示許可を確認。
7. MCP ツール呼び出しは opt-in で実行。結果をユーザーに返す。

## デバッグと運用
- 環境変数:
  - `RKLLM_TEMPLATE=qwen|gemma` でチャットテンプレ切替。
  - `RKLLM_DEBUG_PROMPT=1` で送信プロンプトを stderr に出力（開発時のみ）。
  - `RKLLM_SHOW_TOOL_LIST=1` で MCP ツール一覧を挿入（デフォルトは非表示）。
  - `RKLLM_SHOW_TOOL_LIST_FULL=1` でツール一覧を全文表示（引数情報まで含む）。
  - 追加モデルを使う場合は `RKLLM_TEMPLATE=<name>` を設定し、テンプレ文字列を `src/llm.rs` に追加する（詳細は `docs/model_templates.md` 参照）。

## 今後のタスク（例）
- CLI に `--mode` / `--confirm-writes` / `--backup` 等のオプションを追加し、実装とプロンプトを同期。
- MCP ツール一覧の短縮版/全文版の切替実装。
- プロンプト組み立てを system/user/context/tools の4段で明示的に分離する実装リファクタ。
- Qwen/Gemma 以外のモデルテンプレ定義と、RK3588 向け推奨パラメータの追記。
